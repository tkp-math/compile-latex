name: Compile LaTeX from Google Drive

on:
  workflow_dispatch:
    inputs:
      folderId:
        description: 'Google Drive folder ID'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ① rclone 用に secrets.RCLONE_CONFIG を設定済みとする
      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      # ② Docker コンテナ内で Cloud LaTeX 環境を使用
      - name: Run LaTeX compilation container
        uses: addnab/docker-run-action@v3
        with:
          image: ghcr.io/tkp-math/texlive-ja:latest
          options: --rm
          run: |
            # 作業ディレクトリ
            mkdir -p ./latex_projects

            # ③ Google Drive からフォルダを同期
            rclone sync "gdrive:${{ github.event.inputs.folderId }}" ./latex_projects

            # ④ Python 環境整備
            python -m pip install --upgrade pip
            pip install tqdm

            # ⑤ 再帰的に .tex ファイルをコンパイル（uplatex + dvipdfmx）
            python scripts/compile_all_tex.py ./latex_projects

            # ⑥ 完成した PDF を Google Drive にアップロード
            rclone sync ./latex_projects "gdrive:${{ github.event.inputs.folderId }}"

          shell: sh
