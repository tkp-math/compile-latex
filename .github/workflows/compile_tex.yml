name: Compile LaTeX from Google Drive

on:
  workflow_dispatch:
    inputs:
      folderId:
        description: 'Google Drive folder ID'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ① rclone 用に secrets.RCLONE_CONFIG を設定
      - name: Setup rclone config
        run: |
          mkdir -p $GITHUB_WORKSPACE/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" | base64 -d > $GITHUB_WORKSPACE/.config/rclone/rclone.conf

      # ② Docker コンテナ内で LaTeX コンパイル
      - name: Run LaTeX compilation container
        uses: addnab/docker-run-action@v3
        with:
          image: ghcr.io/tkp-math/texlive-ja:latest
          options: --rm -v ${{ github.workspace }}/.config/rclone:/root/.config/rclone
          run: |
            set -e  # エラーで停止

            # 作業ディレクトリ
            mkdir -p /workspace/latex_projects
            cd /workspace/latex_projects

            # ③ Google Drive からフォルダを同期
            rclone sync --config /root/.config/rclone/rclone.conf \
              --drive-root-folder-id "${{ github.event.inputs.folderId }}" googleDrive: .

            # ④ Python 環境整備
            python3 -m pip install --upgrade pip
            pip3 install tqdm

            # ⑤ 再帰的に .tex ファイルをコンパイル（uplatex + dvipdfmx）
            python3 /github/workspace/compile-latex/scripts/compile_all_tex.py .

            # ⑥ 完成した PDF を Google Drive にアップロード
            rclone sync --config /root/.config/rclone/rclone.conf . \
              --drive-root-folder-id "${{ github.event.inputs.folderId }}" googleDrive:
          shell: sh
