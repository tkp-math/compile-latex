name: Compile LaTeX from Google Drive

on:
  workflow_dispatch:
    inputs:
      folderId:
        description: 'Google Drive folder ID'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 作業ディレクトリの確認
      - name: List workspace
        run: ls -R $GITHUB_WORKSPACE

      # ① rclone 用に secrets.RCLONE_CONFIG を設定
      - name: Setup rclone config
        run: |
          mkdir -p $GITHUB_WORKSPACE/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" | base64 -d > $GITHUB_WORKSPACE/.config/rclone/rclone.conf

      # ② Docker コンテナ内で LaTeX コンパイル
      - name: Run LaTeX compilation container
        uses: addnab/docker-run-action@v3
        with:
          image: ghcr.io/tkp-math/texlive-ja:latest
          options: --rm -v ${{ github.workspace }}/.config/rclone:/root/.config/rclone -v ${{ github.workspace }}:/github/workspace  # ← リポジトリ全体をマウント
          run: |
            set -e  # エラーで停止

            # 作業ディレクトリ
            mkdir -p /workspace/latex_projects
            cd /workspace/latex_projects

            # ③ Google Drive からフォルダを同期
            rclone sync --config /root/.config/rclone/rclone.conf \
              --drive-root-folder-id "${{ github.event.inputs.folderId }}" googleDrive: .

            # ④ Python 環境整備
            python3 -m pip install --upgrade pip
            pip3 install tqdm

            # コンパイル（エラーが出ても続ける）
            STATUS="success"
            PDF_COUNT=0
            set +e
            python3 /github/workspace/scripts/compile_all_tex.py .
            if [ $? -ne 0 ]; then
              STATUS="failure"
            fi
            set -e

            # PDF 数をカウント
            PDF_COUNT=$(find . -name '*.pdf' | wc -l)

            # Google Drive へアップロード
            rclone sync --config /root/.config/rclone/rclone.conf . \
              --drive-root-folder-id "${{ github.event.inputs.folderId }}" googleDrive:

            # Slack / GAS へ通知
            curl -X POST -H "Content-Type: application/json" \
                 -d "{\"token\": \"${{ secrets.GAS_SECRET_TOKEN }}\", \
                      \"status\": \"$STATUS\", \
                      \"repo\": \"${{ github.repository }}\", \
                      \"run_id\": \"${{ github.run_id }}\", \
                      \"pdf_count\": $PDF_COUNT, \
                      \"folder_url\": \"https://drive.google.com/drive/folders/${{ github.event.inputs.folderId }}\"}" \
                 "${{ secrets.GAS_WEBHOOK_URL }}"
          shell: sh
